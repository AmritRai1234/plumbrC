# Logstash pipeline with PlumbrC filter
#
# Place in /etc/logstash/conf.d/plumbr.conf
#
# Uses exec filter to redact secrets before output

input {
  file {
    path => "/var/log/app/*.log"
    start_position => "beginning"
    sincedb_path => "/var/lib/logstash/sincedb"
  }
}

filter {
  # Method 1: Ruby exec (recommended for simple cases)
  ruby {
    code => '
      require "open3"
      msg = event.get("message")
      if msg
        stdout, status = Open3.capture2("/usr/local/bin/plumbr", stdin_data: msg + "\n")
        event.set("message", stdout.strip)
      end
    '
  }

  # Method 2: External command (alternative)
  # Uncomment if you prefer this approach
  # exec {
  #   command => "echo '%{message}' | /usr/local/bin/plumbr"
  #   target => "message"
  # }

  # Parse JSON if your logs are structured
  json {
    source => "message"
    skip_on_invalid_json => true
  }
}

output {
  elasticsearch {
    hosts => ["elasticsearch:9200"]
    index => "app-logs-%{+YYYY.MM.dd}"
  }

  # Debug output (optional)
  # stdout { codec => rubydebug }
}
